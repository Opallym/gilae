{% extends 'base.html.twig' %}

{% block title %}Statistiques{% endblock %}

{% block body %}
    <div class="containerstatistics">
        <div class="stats-cardstatistics">
            <div class="headerstatistics">
                <h1 class="titlestatistics">Statistiques</h1>
                <div class="decorative-arrowsstatistics">
                </div>
            </div>
            <div style="text-align: center;">
                <a href="{{ path('stats') }}" class="refresh-buttonstasts">ðŸ”„ Actualiser</a>
            </div>

            <!-- Boutons de test pour simuler des visites -->
            <div class="test-buttons">
                <strong style="color: #e8f5e8; font-size: 12px; width: 100%; margin-bottom: 8px;">Simuler des visites :</strong>
                {% for key, name in pageNames %}
                    <a href="{{ path('stats', {'visit': key}) }}" class="test-button">{{ name }}</a>
                {% endfor %}
            </div>

            <!-- Container principal des statistiques -->
            <div class="stats-containerstatistics">
                <h2 class="section-titlestatistics">Pages :</h2>
                
                <!-- Total des visites -->
                <div class="total-visitsstatistics">
                    <h3>Total des visites</h3>
                    <div class="number">{{ stats.total }}</div>
                </div>
                
                <!-- Liste des pages avec barres de progression -->
                <div class="stats-liststatistics">
                    {% for page in stats.pages %}
                        <div class="stat-itemstatistics">
                            <div class="stat-headerstatistics">
                                <div class="page-infostatistics">
                                    <span class="page-namestatistics">{{ page.name }}</span>
                                    <span class="visit-countstatistics">{{ page.visits }} visites</span>
                                </div>
                                <span class="percentagestatistics">{{ page.percentage }}%</span>
                            </div>
                            <div class="progress-barstatistics">
                                <div class="progress-fillstatistics" style="width: {{ page.percentage }}%"></div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Footer -->
            <div class="footerstatistics">
                <p>DonnÃ©es mises Ã  jour en temps rÃ©el â€¢ DerniÃ¨re mise Ã  jour : {{ lastUpdate }}</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        // Auto-refresh toutes les 30 secondes
        setTimeout(function() {
            window.location.reload();
        }, 30000);

        // Actualisation en temps rÃ©el via API
        function updateStats() {
            fetch('{{ path('stats_api') }}')
                .then(response => response.json())
                .then(data => {
                    // Mettre Ã  jour les statistiques sans recharger la page
                    document.querySelector('.total-visits .number').textContent = data.stats.total;
                    
                    data.stats.pages.forEach((page, index) => {
                        const statItem = document.querySelectorAll('.stat-item')[index];
                        if (statItem) {
                            statItem.querySelector('.visit-count').textContent = page.visits + ' visites';
                            statItem.querySelector('.percentage').textContent = page.percentage + '%';
                            statItem.querySelector('.progress-fill').style.width = page.percentage + '%';
                        }
                    });
                    
                    document.querySelector('.footer p').innerHTML = 
                        'DonnÃ©es mises Ã  jour en temps rÃ©el â€¢ DerniÃ¨re mise Ã  jour : ' + data.lastUpdate;
                })
                .catch(error => console.error('Erreur lors de la mise Ã  jour:', error));
        }

        // Mettre Ã  jour toutes les 10 secondes
        setInterval(updateStats, 10000);
    </script>
{% endblock %}